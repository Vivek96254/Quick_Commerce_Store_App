// QuickMart Database Schema
// Production-grade quick-commerce platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  CUSTOMER
  ADMIN
  SUPER_ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PACKED
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH_ON_DELIVERY
  STRIPE
  RAZORPAY
}

enum InventoryAction {
  STOCK_IN
  STOCK_OUT
  ADJUSTMENT
  ORDER_RESERVED
  ORDER_COMPLETED
  ORDER_CANCELLED
}

enum OutboxEventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum AdminRole {
  OWNER
  MANAGER
  INVENTORY
  SUPPORT
}

enum OtpPurpose {
  LOGIN
  SIGNUP
  PASSWORD_RESET
  PHONE_VERIFICATION
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id              String    @id @default(cuid())
  email           String?   @unique
  phone           String?   @unique
  passwordHash    String?   @map("password_hash")
  firstName       String?   @map("first_name")
  lastName        String?   @map("last_name")
  role            UserRole  @default(CUSTOMER)
  isActive        Boolean   @default(true) @map("is_active")
  isEmailVerified Boolean   @default(false) @map("is_email_verified")
  isPhoneVerified Boolean   @default(false) @map("is_phone_verified")
  lastLoginAt     DateTime? @map("last_login_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  adminRole       AdminRole? @map("admin_role")

  // Relations
  addresses     Address[]
  cart          Cart?
  orders        Order[]
  refreshTokens RefreshToken[]
  otpCodes      OtpCode[]
  auditLogs     AuditLog[]
  sessions      UserSession[]

  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  family    String?  // Token family for rotation detection
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([family])
  @@map("refresh_tokens")
}

model OtpCode {
  id        String     @id @default(cuid())
  code      String
  userId    String?    @map("user_id")
  phone     String?
  email     String?
  purpose   OtpPurpose
  expiresAt DateTime   @map("expires_at")
  usedAt    DateTime?  @map("used_at")
  attempts  Int        @default(0)
  createdAt DateTime   @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phone, purpose])
  @@index([email, purpose])
  @@index([expiresAt])
  @@map("otp_codes")
}

// ============================================
// ADDRESS MANAGEMENT
// ============================================

model Address {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  label        String?  // Home, Work, etc.
  fullName     String   @map("full_name")
  phone        String
  addressLine1 String   @map("address_line_1")
  addressLine2 String?  @map("address_line_2")
  landmark     String?
  city         String
  state        String
  postalCode   String   @map("postal_code")
  country      String   @default("India")
  latitude     Float?
  longitude    Float?
  isDefault    Boolean  @default(false) @map("is_default")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([userId])
  @@index([isDefault])
  @@map("addresses")
}

// ============================================
// PRODUCT CATALOG
// ============================================

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  image       String?
  parentId    String?  @map("parent_id")
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Self-referencing relation for subcategories
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  // Relations
  products Product[]

  @@index([slug])
  @@index([parentId])
  @@index([isActive])
  @@index([sortOrder])
  @@map("categories")
}

model Product {
  id              String   @id @default(cuid())
  sku             String   @unique
  name            String
  slug            String   @unique
  description     String?
  price           Decimal  @db.Decimal(10, 2)
  discountedPrice Decimal? @map("discounted_price") @db.Decimal(10, 2)
  categoryId      String   @map("category_id")
  unit            String   @default("piece") // piece, kg, litre, etc.
  unitValue       Decimal  @default(1) @map("unit_value") @db.Decimal(10, 3)
  stockQuantity     Int      @default(0) @map("stock_quantity")
  reservedQuantity  Int      @default(0) @map("reserved_quantity")
  lowStockThreshold Int      @default(10) @map("low_stock_threshold")
  isAvailable     Boolean  @default(true) @map("is_available")
  isFeatured      Boolean  @default(false) @map("is_featured")
  tags            String[]
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  category      Category        @relation(fields: [categoryId], references: [id])
  images        ProductImage[]
  cartItems     CartItem[]
  orderItems    OrderItem[]
  inventoryLogs          InventoryLog[]
  stockLocks             StockLock[]
  inventoryReservations  InventoryReservation[]

  @@index([slug])
  @@index([sku])
  @@index([categoryId])
  @@index([isAvailable])
  @@index([isFeatured])
  @@index([stockQuantity])
  @@index([price])
  @@index([createdAt])
  @@map("products")
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String   @map("product_id")
  url       String
  publicId  String?  @map("public_id") // Cloudinary public ID
  altText   String?  @map("alt_text")
  sortOrder Int      @default(0) @map("sort_order")
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([isPrimary])
  @@map("product_images")
}

// ============================================
// INVENTORY MANAGEMENT
// ============================================

model InventoryLog {
  id            String          @id @default(cuid())
  productId     String          @map("product_id")
  action        InventoryAction
  quantity      Int
  previousStock Int             @map("previous_stock")
  newStock      Int             @map("new_stock")
  orderId       String?         @map("order_id")
  notes         String?
  performedBy   String?         @map("performed_by") // User ID who made the change
  createdAt     DateTime        @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id])
  order   Order?  @relation(fields: [orderId], references: [id])

  @@index([productId])
  @@index([orderId])
  @@index([action])
  @@index([createdAt])
  @@map("inventory_logs")
}

model StockLock {
  id        String   @id @default(cuid())
  productId String   @map("product_id")
  quantity  Int
  sessionId String   @map("session_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sessionId])
  @@index([expiresAt])
  @@map("stock_locks")
}

// ============================================
// CART MANAGEMENT
// ============================================

model Cart {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  sessionId String?  @map("session_id")
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@index([sessionId])
  @@index([expiresAt])
  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String   @map("cart_id")
  productId String   @map("product_id")
  quantity  Int
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

// ============================================
// ORDER MANAGEMENT
// ============================================

model Order {
  id                 String        @id @default(cuid())
  orderNumber        String        @unique @map("order_number")
  userId             String        @map("user_id")
  addressId          String        @map("address_id")
  status             OrderStatus   @default(PENDING)
  subtotal           Decimal       @db.Decimal(10, 2)
  deliveryFee        Decimal       @default(0) @map("delivery_fee") @db.Decimal(10, 2)
  discount           Decimal       @default(0) @db.Decimal(10, 2)
  tax                Decimal       @default(0) @db.Decimal(10, 2)
  total              Decimal       @db.Decimal(10, 2)
  paymentMethod      PaymentMethod @map("payment_method")
  notes              String?
  estimatedDelivery  DateTime?     @map("estimated_delivery")
  confirmedAt        DateTime?     @map("confirmed_at")
  packedAt           DateTime?     @map("packed_at")
  dispatchedAt       DateTime?     @map("dispatched_at")
  deliveredAt        DateTime?     @map("delivered_at")
  cancelledAt        DateTime?     @map("cancelled_at")
  cancellationReason String?       @map("cancellation_reason")
  slaBreachedAt      DateTime?     @map("sla_breached_at")
  metadata           Json?
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  // Snapshot of delivery address at order time
  deliveryAddress Json @map("delivery_address")

  // Relations
  user          User           @relation(fields: [userId], references: [id])
  address       Address        @relation(fields: [addressId], references: [id])
  items         OrderItem[]
  payment       Payment?
  statusHistory OrderStatusHistory[]
  inventoryLogs InventoryLog[]

  @@index([orderNumber])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([paymentMethod])
  @@map("orders")
}

model OrderItem {
  id              String  @id @default(cuid())
  orderId         String  @map("order_id")
  productId       String  @map("product_id")
  quantity        Int
  unitPrice       Decimal @map("unit_price") @db.Decimal(10, 2)
  discountedPrice Decimal? @map("discounted_price") @db.Decimal(10, 2)
  total           Decimal @db.Decimal(10, 2)

  // Snapshot of product details at order time
  productSnapshot Json @map("product_snapshot")

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String      @map("order_id")
  status    OrderStatus
  notes     String?
  changedBy String?     @map("changed_by") // User ID who made the change
  createdAt DateTime    @default(now()) @map("created_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([createdAt])
  @@map("order_status_history")
}

// ============================================
// PAYMENT MANAGEMENT
// ============================================

model Payment {
  id                String        @id @default(cuid())
  orderId           String        @unique @map("order_id")
  amount            Decimal       @db.Decimal(10, 2)
  currency          String        @default("INR")
  method            PaymentMethod
  status            PaymentStatus @default(PENDING)
  
  // Payment gateway details
  gatewayOrderId    String?       @map("gateway_order_id")
  gatewayPaymentId  String?       @map("gateway_payment_id")
  gatewaySignature  String?       @map("gateway_signature")
  
  // Metadata
  failureReason     String?       @map("failure_reason")
  refundId          String?       @map("refund_id")
  refundAmount      Decimal?      @map("refund_amount") @db.Decimal(10, 2)
  refundedAt        DateTime?     @map("refunded_at")
  metadata          Json?
  
  paidAt            DateTime?     @map("paid_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([gatewayOrderId])
  @@index([gatewayPaymentId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// ============================================
// STORE CONFIGURATION
// ============================================

model StoreConfig {
  id               String   @id @default(cuid())
  name             String
  description      String?
  logo             String?
  phone            String?
  email            String?
  address          String?
  city             String?
  state            String?
  postalCode       String?  @map("postal_code")
  country          String   @default("India")
  currency         String   @default("INR")
  currencySymbol   String   @default("â‚¹") @map("currency_symbol")
  timezone         String   @default("Asia/Kolkata")
  
  // Delivery settings
  deliveryRadius   Float?   @map("delivery_radius") // in km
  minOrderAmount   Decimal  @default(0) @map("min_order_amount") @db.Decimal(10, 2)
  deliveryFee      Decimal  @default(0) @map("delivery_fee") @db.Decimal(10, 2)
  freeDeliveryAbove Decimal? @map("free_delivery_above") @db.Decimal(10, 2)
  
  // Operating hours (JSON with day-wise timings)
  operatingHours   Json?    @map("operating_hours")
  isOpen           Boolean  @default(true) @map("is_open")
  
  // Tax settings
  taxRate          Decimal  @default(0) @map("tax_rate") @db.Decimal(5, 2)
  taxInclusive     Boolean  @default(true) @map("tax_inclusive")
  
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("store_config")
}

// ============================================
// ANALYTICS & LOGGING
// ============================================

model DailySalesStats {
  id           String   @id @default(cuid())
  date         DateTime @db.Date
  totalOrders  Int      @default(0) @map("total_orders")
  totalRevenue Decimal  @default(0) @map("total_revenue") @db.Decimal(12, 2)
  avgOrderValue Decimal @default(0) @map("avg_order_value") @db.Decimal(10, 2)
  newCustomers Int      @default(0) @map("new_customers")
  topProducts  Json?    @map("top_products")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([date])
  @@index([date])
  @@map("daily_sales_stats")
}

// ============================================
// IDEMPOTENCY
// ============================================

model IdempotencyKey {
  id              String   @id @default(cuid())
  key             String   @unique
  requestHash     String   @map("request_hash")
  responsePayload Json?    @map("response_payload")
  statusCode      Int?     @map("status_code")
  expiresAt       DateTime @map("expires_at")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([key])
  @@index([expiresAt])
  @@map("idempotency_keys")
}

// ============================================
// TRANSACTIONAL OUTBOX
// ============================================

model OutboxEvent {
  id          String            @id @default(cuid())
  type        String
  payload     Json
  status      OutboxEventStatus @default(PENDING)
  retries     Int               @default(0)
  maxRetries  Int               @default(5) @map("max_retries")
  lastError   String?           @map("last_error")
  processedAt DateTime?         @map("processed_at")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("outbox_events")
}

// ============================================
// INVENTORY RESERVATIONS
// ============================================

model InventoryReservation {
  id         String    @id @default(cuid())
  productId  String    @map("product_id")
  orderId    String?   @map("order_id")
  userId     String    @map("user_id")
  sessionId  String?   @map("session_id")
  quantity   Int
  expiresAt  DateTime  @map("expires_at")
  releasedAt DateTime? @map("released_at")
  convertedAt DateTime? @map("converted_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([orderId])
  @@index([userId])
  @@index([expiresAt])
  @@index([releasedAt])
  @@map("inventory_reservations")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  action     String
  resource   String
  resourceId String?  @map("resource_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// USER SESSIONS (Device Tracking)
// ============================================

model UserSession {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  deviceInfo  String?   @map("device_info")
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  lastActiveAt DateTime @default(now()) @map("last_active_at")
  expiresAt   DateTime  @map("expires_at")
  revokedAt   DateTime? @map("revoked_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("user_sessions")
}

// ============================================
// PUSH NOTIFICATION TOKENS (Mobile Reliability)
// ============================================

model PushToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  platform  String   // 'fcm' | 'apns' | 'web'
  deviceId  String?  @map("device_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([token])
  @@map("push_tokens")
}

// ============================================
// WEBHOOK REPLAY PROTECTION
// ============================================

model WebhookEvent {
  id          String    @id @default(cuid())
  provider    String
  eventId     String    @map("event_id")
  eventType   String    @map("event_type")
  payload     Json
  processedAt DateTime? @map("processed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@unique([provider, eventId])
  @@index([provider, eventId])
  @@index([createdAt])
  @@map("webhook_events")
}
